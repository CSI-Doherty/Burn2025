---
title: "01_Liver_QC_Ruining"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

```{r message=FALSE}
pkgs <- c("Seurat", "tidyverse", "ggpubr", "RColorBrewer")
easypackages::packages(pkgs)

if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
bioc_pkgs <- c("edgeR", "org.Mm.eg.db", "limma", "GO.db")
#BiocManager::install(bioc_pkgs)
easypackages::libraries(bioc_pkgs)
```
```{r}
wd <- getwd() #"/data/gpfs/projects/punim1612/Mackay_Liver_Cancer/Ruining"
data_dir <- "~/CSI/Mackay_Liver_Cancer/data/"
```

# checking genes
### Lane A
```{r}
lib_A = Read10X("../data/CITE-GEX-A/outs/filtered_feature_bc_matrix/")
seu_A = CreateSeuratObject(lib_A$`Gene Expression`)

seu_A= NormalizeData(seu_A)
seu_A= FindVariableFeatures(seu_A)
seu_A= ScaleData(seu_A)

seu_A= RunPCA(seu_A, verbose = F)
seu_A= RunUMAP(seu_A, dims = 1:30)

seu_A[["CITE"]] = CreateAssayObject(lib_A$`Antibody Capture`)
seu_A= NormalizeData(seu_A, assay = "CITE")

FPs_A <- ggarrange(FeaturePlot(seu_A, features = c("Hu.CD69", "Hu.CD103", "Hu.CD4-RPA.T4", "Hu.CD8")),
          FeaturePlot(seu_A, features = c("CD69", "ITGAE", "CD4", "CD8A")))
ggsave(FPs_A, filename = paste0(wd, "/FeaturePlots_A.pdf"), width = 14, height = 7)
```
### Lane B
```{r}
lib_B = Read10X("~/CSI/Mackay_Liver_Cancer/data/cellranger_multi_lib_B/outs/per_sample_outs/cellranger_multi_lib_B/count/sample_feature_bc_matrix")
seu_B = CreateSeuratObject(lib_B$`Gene Expression`)

seu_B = NormalizeData(seu_B)
seu_B = FindVariableFeatures(seu_B)
seu_B = ScaleData(seu_B)

seu_B = RunPCA(seu_B, verbose = F)
seu_B = RunUMAP(seu_B, dims = 1:30)

seu_B[["CITE"]] = CreateAssayObject(lib_B$`Antibody Capture`)
seu_B = NormalizeData(seu_B, assay = "CITE")

FPs_B <- ggarrange(FeaturePlot(seu_B, features = c("Hu.CD69", "Hu.CD103", "Hu.CD4-RPA.T4", "Hu.CD8")),
          FeaturePlot(seu_B, features = c("CD69", "ITGAE", "CD4", "CD8A")))
ggsave(FPs_B, filename = paste0(wd, "/FeaturePlots_B.pdf"), width = 14, height = 7)
```

### Lane C
```{r}
lib_C = Read10X(paste0(data_dir, "cellranger_multi_lib_C/outs/per_sample_outs/cellranger_multi_lib_C/count/sample_feature_bc_matrix"))
seu_C = CreateSeuratObject(lib_C$`Gene Expression`)

seu_C = NormalizeData(seu_C)
seu_C = FindVariableFeatures(seu_C)
seu_C = ScaleData(seu_C)

seu_C = RunPCA(seu_C, verbose = F)
seu_C = RunUMAP(seu_C, dims = 1:30)

seu_C[["CITE"]] = CreateAssayObject(lib_C$`Antibody Capture`)
seu_C = NormalizeData(seu_C, assay = "CITE")

FPs_C <- ggarrange(FeaturePlot(seu_C, features = c("Hu.CD69", "Hu.CD103", "Hu.CD4-RPA.T4", "Hu.CD8")),
          FeaturePlot(seu_C, features = c("CD69", "ITGAE", "CD4", "CD8A")))
ggsave(FPs_C, filename = paste0(wd, "/FeaturePlots_C.pdf"), width = 14, height = 7)
```
All libraries look fine so far. The next step is to remove outliers by two features.
```{r}
saveRDS(seu_A, file=paste0(wd, "/seu_A.Rds"))
saveRDS(seu_B, file=paste0(wd, "/seu_B.Rds"))
saveRDS(seu_C, file=paste0(wd, "/seu_C.Rds"))
```



#filter

## density plot
### nFeature_RNA
no. genes per cell, chuck too high and too low: *800, 600, 800 - 3000*
```{r}
#nFeature_RNA 
seu <- list(A=seu_A, B=seu_B, C=seu_C) 
mapply(function(x, y) tibble(name=names(x$nFeature_RNA), n=x$nFeature_RNA, lib=y), seu, names(seu), SIMPLIFY = F) %>% 
  purrr::reduce(., rbind) %>% 
  ggplot(aes(n)) + geom_histogram() + facet_wrap(~lib) + 
  geom_vline(aes(xintercept = x), color="red", data=data.frame(lib=c("A","B","C"), x=c(800, 600, 800))) +
  geom_vline(xintercept = 3000, color="blue") +
  theme_minimal() + 
  ggtitle("nFeature_RNA (<=5000)") + xlim(0, 5000)
```
```{r}
lapply(seu, function(x) list(sd(x$nFeature_RNA), mean(x$nFeature_RNA)))
```

### mt per cell
perp. of mt per cell
```{r}
lapply(seu, function(x) x@assays$RNA %>% rownames() %>% stringr::str_detect(., "^MT-") %>% rownames(x@assays$RNA)[.])
```
```{r}
meta.data_percMT <- lapply(seu, function(x) bind_cols(x@meta.data, PercentageFeatureSet(x, pattern = "^MT-")) %>% `colnames<-`(c(colnames(x@meta.data), "percent_MT")))
for (i in seq(1:3)) {
  seu[[i]]@meta.data <- meta.data_percMT[[i]]
}
#save 24/06/22
saveRDS(seu, file=paste0(wd, "/seu.Rds"))
```

```{r}
mapply(function(x, y) tibble(name=names(x$percent_MT), n=x$percent_MT, lib=y), seu, names(seu), SIMPLIFY = F) %>% 
  purrr::reduce(., rbind) %>% 
  ggplot(aes(n)) + geom_density() + facet_wrap(~lib) + 
  #geom_vline(aes(xintercept = x), color="red", data=data.frame(lib=c("A","B","C"), x=c(800, 600, 800))) +
  #geom_vline(xintercept = 3000, color="blue") +
  theme_minimal() + xlim(0, 10) +
  geom_vline(aes(xintercept = x), color="red", data=data.frame(lib=c("A","B","C"), x=c(6, 10, 6))) +
  ggtitle("percent_MT (<=10%)")
```

```{r}
seu_filtered <- mapply(function(x, mt, nF_min, nF_max) x[, x$percent_MT <= mt & x$nFeature_RNA >= nF_min & x$nFeature_RNA <= nF_max], seu, c(6, 10, 6), c(800, 600, 800), 3000, SIMPLIFY = F) 
```

```{r}
seu_filtered_A_B_C <- merge(seu_filtered$A, y = c(seu_filtered$B, seu_filtered$C))
```

```{r}
seu_filtered_A_B_C <- NormalizeData(seu_filtered_A_B_C)
seu_filtered_A_B_C <- FindVariableFeatures(seu_filtered_A_B_C)
saveRDS(seu_filtered_A_B_C, file=paste0(wd, "/seu_filtered_A_B_C.Rds"))
```

```{r}
oldvarfeatures_RNA = seu_filtered_A_B_C@assays$RNA@var.features
oldvarfeatures_RNA = oldvarfeatures_RNA[!grepl("TR[AB]", oldvarfeatures_RNA) & !grepl("^MT-", oldvarfeatures_RNA)]
```

Some genes start with MT and are possibly pseudogenes of MT genes. These are kept in `oldvarfeatures_RNA` and removed from `oldvarfeatures_RNA_noMT`.
```{r}
oldvarfeatures_RNA[str_detect(oldvarfeatures_RNA, "^MT")]
oldvarfeatures_RNA_noMT = oldvarfeatures_RNA[!grepl("^MT", oldvarfeatures_RNA)]
```

# Dimplots
```{r}
seu_filtered_A_B_C_SCT_RNA = SCTransform(seu_filtered_A_B_C, residual.features = oldvarfeatures_RNA)
```
```{r}
seu_filtered_A_B_C_SCT_RNA = RunPCA(seu_filtered_A_B_C_SCT_RNA, verbose = F, features = oldvarfeatures_RNA)
ElbowPlot(seu_filtered_A_B_C_SCT_RNA)
seu_filtered_A_B_C_SCT_RNA = FindNeighbors(seu_filtered_A_B_C_SCT_RNA, dims = 1:30)
seu_filtered_A_B_C_SCT_RNA = RunUMAP(seu_filtered_A_B_C_SCT_RNA, dims = 1:30)
seu_filtered_A_B_C_SCT_RNA = FindClusters(seu_filtered_A_B_C_SCT_RNA)
DimPlot(seu_filtered_A_B_C_SCT_RNA, label = T)
```
# feature plots

Hu.CD8 is clustered in cluster 13, and that's good. Yay!
```{r}
seu_filtered_A_B_C_SCT_RNA = NormalizeData(seu_filtered_A_B_C_SCT_RNA, assay = "CITE")
FeaturePlot(seu_filtered_A_B_C_SCT_RNA, features = c("Hu.CD69", "Hu.CD103", "Hu.CD4-RPA.T4", "Hu.CD8"))
ggsave(filename = paste0(wd, "/FeaturePlots_A_B_C_CITE.pdf"), width = 14, height = 7)
```

# WNN analysis
## normalising data
Omitting RNA normalisation because it has been done by `SCTransform()`.
```{r}
DefaultAssay(seu_filtered_A_B_C_SCT_RNA) <- 'CITE'
VariableFeatures(seu_filtered_A_B_C_SCT_RNA) <- rownames(seu_filtered_A_B_C_SCT_RNA[["CITE"]])
seu_filtered_A_B_C_SCT_RNA <- NormalizeData(seu_filtered_A_B_C_SCT_RNA, normalization.method = 'CLR', margin = 2) %>% 
  ScaleData() %>% RunPCA(reduction.name = 'apca')
```


```{r}
# Identify multimodal neighbors. These will be stored in the neighbors slot, 
# and can be accessed using seu_filtered_A_B_C_SCT_RNA[['weighted.nn']]
# The WNN graph can be accessed at seu_filtered_A_B_C_SCT_RNA[["wknn"]], 
# and the SNN graph used for clustering at seu_filtered_A_B_C_SCT_RNA[["wsnn"]]
# Cell-specific modality weights can be accessed at seu_filtered_A_B_C_SCT_RNA$RNA.weight
seu_filtered_A_B_C_SCT_RNA <- FindMultiModalNeighbors(
  seu_filtered_A_B_C_SCT_RNA, reduction.list = list("pca", "apca"), 
  dims.list = list(1:30, 1:18), modality.weight.name = "SCT.weight"
)
ElbowPlot(seu_filtered_A_B_C_SCT_RNA, reduction = "apca", ndims = 30)
```
## UMAPs
```{r}
seu_filtered_A_B_C_SCT_RNA <- RunUMAP(seu_filtered_A_B_C_SCT_RNA, nn.name = "weighted.nn", reduction.name = "wnn.umap", reduction.key = "wnnUMAP_")
seu_filtered_A_B_C_SCT_RNA <- FindClusters(seu_filtered_A_B_C_SCT_RNA, graph.name = "wsnn", algorithm = 3, resolution = 2, verbose = FALSE)
```

```{r}
p1 <- DimPlot(seu_filtered_A_B_C_SCT_RNA, reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + NoLegend()
p1
#p2 <- DimPlot(seu_filtered_A_B_C_SCT_RNA, reduction = 'wnn.umap', group.by = 'var.features', label = TRUE, repel = TRUE, label.size = 2.5) + NoLegend()
#p1 + p2
ggsave(p1, filename = paste0(wd, "/UMAP_A_B_C_WNN.pdf"), width = 7, height = 7)
```

```{r}
#only RNA
seu_filtered_A_B_C_SCT_RNA <- RunUMAP(seu_filtered_A_B_C_SCT_RNA, reduction = 'pca', dims = 1:30, assay = 'RNA', 
              reduction.name = 'rna.umap', reduction.key = 'rnaUMAP_')
seu_filtered_A_B_C_SCT_RNA <- RunUMAP(seu_filtered_A_B_C_SCT_RNA, reduction = 'apca', dims = 1:18, assay = 'CITE', 
              reduction.name = 'cite.umap', reduction.key = 'citeUMAP_')
p3 <- DimPlot(seu_filtered_A_B_C_SCT_RNA, reduction = 'rna.umap', label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p4 <- DimPlot(seu_filtered_A_B_C_SCT_RNA, reduction = 'cite.umap', label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p3 + p4
ggsave(p3 + p4, filename = paste0(wd, "/UMAPs_A_B_C_RNA+CITE.pdf"), width = 14, height = 7)
```

## Feature plots
```{r}
p5 <- FeaturePlot(seu_filtered_A_B_C_SCT_RNA, features = c("Hu.CD69", "Hu.CD103", "Hu.CD4-RPA.T4", "Hu.CD8"),
                  reduction = 'wnn.umap', #max.cutoff = 2, 
                  cols = c("lightgrey","darkgreen"), ncol = 2)

DefaultAssay(seu_filtered_A_B_C_SCT_RNA) <- 'SCT'
p6 <- FeaturePlot(seu_filtered_A_B_C_SCT_RNA, features = c("CD69", "ITGAE", "CD4", "CD8A"), 
                  reduction = 'wnn.umap', #max.cutoff = 3, 
                  ncol = 2)
p5 / p6
ggsave(ggarrange(p5, p6), filename = paste0(wd, "/FeaturePlots_wnn.pdf"), width = 14, height = 7)
```

```{r}
saveRDS(seu_filtered_A_B_C_SCT_RNA, file=paste0(wd, "/seu_filtered_A_B_C_SCT_RNA.Rds"))
```

